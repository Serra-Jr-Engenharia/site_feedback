name: Manter Projeto Supabase Ativo!

on:
  schedule:
    # Roda toda segunda-feira às 3:00 da manhã.
    # Ajuste conforme necessário.
    - cron: '0 3 * * 1'

  # (Opcional) Permite rodar manualmente pelo GitHub Actions UI.
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependência do Supabase
        run: npm install @supabase/supabase-js

      - name: Executar consulta para manter o projeto ativo
        run: |
          node --input-type=module -e "
            import { createClient } from '@supabase/supabase-js';

            const supabaseUrl = process.env.SUPABASE_URL;
            const supabaseKey = process.env.SUPABASE_KEY;

            if (!supabaseUrl || !supabaseKey) {
              console.error('❌ As secrets do Supabase não foram configuradas.');
              process.exit(1);
            }

            const supabase = createClient(supabaseUrl, supabaseKey);

            const pingDatabase = async () => {
              try {
                const { error, count } = await supabase
                  .from('satisfaction_forms')
                  .select('id', { count: 'exact', head: true });

                if (error) throw error;

                console.log('✅ Ping no Supabase realizado com sucesso! Total de respostas:', count);
              } catch (error) {
                console.error('❌ Falha ao fazer ping no Supabase:', error.message);
                process.exit(1);
              }
            };

            pingDatabase();
          "
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}